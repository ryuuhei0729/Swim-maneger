<% content_for :title, 'Attendance' %>

<div class="mt-2">
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-2xl font-bold text-gray-900">出席管理</h2>
    <%= link_to "出欠情報を編集する", edit_attendance_path, class: "bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-200", data: { turbo: false } %>
  </div>
  
<!-- 出席管理フォーム -->
<div class="mb-8 bg-white rounded-lg shadow p-6">
  <h3 class="text-xl font-semibold mb-4">出席管理（受付中）</h3>
  <% if @open_events.any? %>
    <%= form_with(url: update_attendance_path, method: :post, class: "space-y-2") do |f| %>

      <% @open_events.each do |event| %>
        <div class="flex items-center gap-4 py-2 px-4 border border-gray-200 rounded-lg">
          <!-- 日付・イベント名・場所 -->
          <div class="w-48 flex-shrink-0">
            <div class="text-sm font-medium"><%= event.date.strftime("%m月%d日") %>(<%= japanese_weekday(event.date) %>)</div>
            <div class="text-sm text-gray-600"><%= event.title %></div>
            <% if event.place.present? %>
              <div class="text-xs text-gray-500">@<%= event.place %></div>
            <% end %>
          </div>

          <!-- 出席ステータス -->
          <% attendance = @attendance.find_by(attendance_event: event) %>
          <div class="flex items-center gap-6">
            <div class="flex items-center gap-1">
              <%= f.radio_button "attendance[#{event.id}][status]", "present", checked: attendance&.status == "present", class: "form-radio", data: { requires_note: false } %>
              <%= f.label "attendance[#{event.id}][status]", "出席", value: "present", class: "text-sm cursor-pointer" %>
            </div>

            <div class="flex items-center gap-1">
              <%= f.radio_button "attendance[#{event.id}][status]", "absent", checked: attendance&.status == "absent", class: "form-radio", data: { requires_note: true } %>
              <%= f.label "attendance[#{event.id}][status]", "欠席", value: "absent", class: "text-sm cursor-pointer" %>
            </div>

            <div class="flex items-center gap-1">
              <%= f.radio_button "attendance[#{event.id}][status]", "other", checked: attendance&.status == "other", class: "form-radio", data: { requires_note: true } %>
              <%= f.label "attendance[#{event.id}][status]", "その他（遅刻・早退など）", value: "other", class: "text-sm cursor-pointer" %>
            </div>
          </div>

          <!-- 備考欄 -->
          <div class="flex-1">
            <%= f.text_area "attendance[#{event.id}][note]", 
            value: attendance&.note,
            class: "w-full text-sm rounded border border-gray-200 px-2 py-1 h-auto resize-none", 
            rows: 1, required: false, 
            placeholder: "欠席・その他の場合は必ず理由を入力" %>
          </div>
        </div>
      <% end %>

      <div class="mt-4">
        <%= f.submit "すべての回答を保存", class: "bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700" %>
      </div>
    <% end %>
  <% else %>
    <p class="text-gray-600">受付中のイベントはありません。</p>
  <% end %>
</div>

<!-- カレンダー表示部分 -->
<div class="overflow-x-auto">
  <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
    <%= render 'shared/calendar' %>
  </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
  const radioButtons = document.querySelectorAll('input[type="radio"]');

  radioButtons.forEach(radio => {
    radio.addEventListener('change', function() {
      const requiresNote = this.dataset.requiresNote === 'true';
      const textArea = this.closest('.flex').querySelector('textarea');
      if (textArea) {
        textArea.required = requiresNote;
      }
    });
  });
});
</script>
</div> 