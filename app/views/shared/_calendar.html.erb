<%# „Ç´„É¨„É≥„ÉÄ„Éº„ÅÆ„Éë„Éº„Ç∑„É£„É´ %>
<% 
  # locals„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Åù„Çå„Çí‰ΩøÁî®„ÄÅ„Å™„ÅÑÂ†¥Âêà„ÅØ„Ç§„É≥„Çπ„Çø„É≥„ÇπÂ§âÊï∞„Çí‰ΩøÁî®Ôºà‰∏ã‰Ωç‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÔºâ
  current_month = local_assigns[:current_month] || @current_month
  events_by_date = local_assigns[:events_by_date] || @events_by_date
  birthdays_by_date = local_assigns[:birthdays_by_date] || @birthdays_by_date
  user_attendance_by_event = local_assigns[:user_attendance_by_event] || @user_attendance_by_event
%>
<div class="bg-white shadow-lg rounded-xl overflow-hidden" id="calendar" data-controller="calendar">
  <%= hidden_field_tag :current_month, current_month.strftime("%Y-%m-%d"), data: { calendar_target: "currentMonth" } %>
  
  <%# „Ç´„É¨„É≥„ÉÄ„Éº„Éò„ÉÉ„ÉÄ„Éº %>
  <div class="bg-blue-800 p-4">
    <div class="flex items-center justify-between">
      <h3 class="text-xl font-bold text-white" data-calendar-target="header"><%= "#{current_month.year}Âπ¥#{current_month.month}Êúà" %></h3>
      <div class="flex space-x-2">
        <button type="button" data-action="click->calendar#prevMonth" class="p-2 bg-white/20 text-white rounded-full hover:bg-white/30 transition-colors duration-200 cursor-pointer">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
        </button>
        <button type="button" data-action="click->calendar#today" class="w-10 h-10 flex items-center justify-center bg-white/20 text-white rounded-full hover:bg-white/30 transition-colors duration-200 text-sm cursor-pointer">
          ‰ªäÊó•
        </button>
        <button type="button" data-action="click->calendar#nextMonth" class="p-2 bg-white/20 text-white rounded-full hover:bg-white/30 transition-colors duration-200 cursor-pointer">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </button>
      </div>
    </div>
  </div>

  <%# „Ç´„É¨„É≥„ÉÄ„ÉºÊú¨‰Ωì %>
  <div class="p-4">
    <%# ÊõúÊó•„ÅÆ„Éò„ÉÉ„ÉÄ„Éº %>
    <div class="grid grid-cols-7 gap-1 mb-2">
      <% %w[Êó• Êúà ÁÅ´ Ê∞¥ Êú® Èáë Âúü].each do |day| %>
        <div class="text-center py-2 font-medium text-gray-600 text-sm">
          <%= day %>
        </div>
      <% end %>
    </div>

    <%# „Ç´„É¨„É≥„ÉÄ„Éº„ÅÆÊó•‰ªò %>
    <div class="grid grid-cols-7 gap-1">
      <% calendar_start = current_month.beginning_of_month.beginning_of_week(:sunday) %>
      <% calendar_end = current_month.end_of_month.end_of_week(:sunday) %>
      <% holidays = HolidayJp.between(calendar_start, calendar_end).index_by(&:date) %>
      <% (calendar_start..calendar_end).each do |date| %>
        <% is_today = date == Date.current %>
        <% is_current_month = date.month == current_month.month %>
        <% is_holiday = holidays[date].present? %>
        <% is_sunday = date.sunday? %>
        <% is_saturday = date.saturday? %>
        <% events = events_by_date&.dig(date) || [] %>
        <% birthdays = birthdays_by_date&.dig(date) || [] %>
        
        <%# ËÉåÊôØËâ≤„ÅÆÊ±∫ÂÆöÔºàÂÑ™ÂÖàÈ†Ü‰Ωç: Á•ùÊó• > Êó•Êõú > ÂúüÊõúÔºâ %>
        <% bg_color = if is_current_month
          if is_holiday
            'bg-red-100'
          elsif is_sunday
            'bg-red-50'
          elsif is_saturday
            'bg-blue-50'
          else
            'bg-white'
          end
        else
          'bg-gray-200'
        end %>
        
        <%# ÊñáÂ≠óËâ≤„ÅÆÊ±∫ÂÆöÔºàÂÑ™ÂÖàÈ†Ü‰Ωç: Á•ùÊó• > Êó•Êõú > ÂúüÊõúÔºâ %>
        <% text_color = if is_holiday
          'text-red-600'
        elsif is_sunday
          'text-red-600'
        elsif is_saturday
          'text-blue-600'
        else
          is_current_month ? 'text-gray-900' : 'text-gray-400'
        end %>
        
        <div class="min-h-[100px] p-2 border rounded-lg <%= bg_color %> <%= is_today ? 'ring-2 ring-blue-500' : '' %> hover:shadow-md transition-shadow duration-200">
          <div class="flex justify-between items-start">
            <div class="text-sm font-medium <%= text_color %> <%= is_today ? 'bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center' : '' %>">
              <%= date.day %>
            </div>
            <% if is_today %>
              <span class="text-xs bg-blue-100 text-blue-800 px-1.5 py-0.5 rounded-full">‰ªäÊó•</span>
            <% end %>
            <% if is_holiday && is_current_month %>
              <span class="text-xs bg-red-100 text-red-800 px-1.5 py-0.5 rounded-full"><%= holidays[date].name %></span>
            <% end %>
          </div>
          
          <%# Ë™ïÁîüÊó•Ë°®Á§∫ %>
          <% if birthdays.any? && is_current_month %>
            <div class="mt-1 space-y-1">
              <% birthdays.each do |user| %>
                <div class="flex items-center space-x-1">
                  <span class="text-pink-500">üéÇ</span>
                  <span class="text-xs text-pink-700 bg-pink-100 px-1.5 py-0.5 rounded-full">
                    <%= user.name %>„ÅÆË™ïÁîüÊó•
                  </span>
                </div>
              <% end %>
            </div>
          <% end %>
          
          <% if events.any? %>
            <div class="mt-2 space-y-2">
              <%# Event > Competition > AttendanceEvent„ÅÆÈ†Ü„Åß„ÇΩ„Éº„Éà %>
              <% sorted_events = events.sort_by do |event| 
                case event.class.name
                when 'Event'
                  0
                when 'Competition'
                  1
                when 'AttendanceEvent'
                  2
                else
                  3
                end
              end %>
              <% sorted_events.each do |event| %>
                <% if event.is_a?(Competition) %>
                  <%# Competition„ÅÆÂ†¥Âêà - ËñÑ„ÅÑËµ§Ëâ≤„ÅßË°®Á§∫ %>
                  <div class="group relative">
                    <div
                      class="p-2 rounded-md border border-red-200 shadow-md hover:shadow-lg transition-all duration-200 cursor-pointer bg-red-50 text-red-800"
                      data-action="click->calendar#showEventModal"
                      data-event-id="<%= event.id %>"
                    >
                      <div class="flex flex-col space-y-1">
                        <span class="text-xs font-bold text-red-800"><%= event.title %></span>
                        <% if event.place.present? %>
                          <span class="text-[10px] text-red-600">@<%= event.place %></span>
                        <% end %>
                        <% user_attendance = user_attendance_by_event&.dig(event.id) %>
                        <% if user_attendance %>
                          <% case user_attendance.status %>
                          <% when 'present', 'Âá∫Â∏≠' %>
                            <span class="text-[10px] text-green-800 bg-green-100 px-1.5 py-0.5 rounded-full self-start font-semibold">
                              Âá∫Â∏≠
                            </span>
                          <% when 'absent', 'Ê¨†Â∏≠' %>
                            <span class="text-[10px] text-red-800 bg-red-100 px-1.5 py-0.5 rounded-full self-start font-semibold">
                              Ê¨†Â∏≠
                            </span>
                          <% when 'other', '„Åù„ÅÆ‰ªñ' %>
                            <span class="text-[10px] text-yellow-800 bg-yellow-100 px-1.5 py-0.5 rounded-full self-start font-semibold">
                              „Åù„ÅÆ‰ªñ
                            </span>
                          <% else %>
                            <span class="text-[10px] text-gray-600 bg-gray-200 px-1.5 py-0.5 rounded-full self-start">
                              <%= user_attendance.status %>
                            </span>
                          <% end %>
                        <% else %>
                          <span class="text-[10px] text-orange-700 bg-orange-100 px-1.5 py-0.5 rounded-full self-start">
                            Êú™ÂõûÁ≠î
                          </span>
                        <% end %>
                      </div>
                    </div>
                    <% if event.note.present? %>
                      <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-white text-gray-900 text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-10 border border-gray-200 shadow-lg">
                        <%= event.note %>
                        <div class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-white"></div>
                      </div>
                    <% end %>
                  </div>
                <% elsif event.is_a?(AttendanceEvent) %>
                  <%# AttendanceEvent„ÅÆÂ†¥Âêà - „ÇØ„É™„ÉÉ„ÇØÂèØËÉΩ„ÅßÂá∫Â∏≠ÊÉÖÂ†±„ÇíË°®Á§∫ %>
                  <div class="group relative">
                    <div
                      class="p-2 rounded-md border border-gray-200 shadow-sm hover:shadow-md transition-all duration-200 cursor-pointer bg-white/80 backdrop-blur-sm"
                      data-action="click->calendar#showEventModal"
                      data-event-id="<%= event.id %>"
                    >
                      <div class="flex flex-col space-y-1">
                        <span class="text-xs font-medium text-gray-900"><%= event.title %></span>
                        <% if event.place.present? %>
                          <span class="text-[10px] text-gray-600">@<%= event.place %></span>
                        <% end %>
                        <% user_attendance = user_attendance_by_event&.dig(event.id) %>
                        <% if user_attendance %>
                          <% case user_attendance.status %>
                          <% when 'present', 'Âá∫Â∏≠' %>
                            <span class="text-[10px] text-green-800 bg-green-100 px-1.5 py-0.5 rounded-full self-start font-semibold">
                              Âá∫Â∏≠
                            </span>
                          <% when 'absent', 'Ê¨†Â∏≠' %>
                            <span class="text-[10px] text-red-800 bg-red-100 px-1.5 py-0.5 rounded-full self-start font-semibold">
                              Ê¨†Â∏≠
                            </span>
                          <% when 'other', '„Åù„ÅÆ‰ªñ' %>
                            <span class="text-[10px] text-yellow-800 bg-yellow-100 px-1.5 py-0.5 rounded-full self-start font-semibold">
                              „Åù„ÅÆ‰ªñ
                            </span>
                          <% else %>
                            <span class="text-[10px] text-gray-600 bg-gray-200 px-1.5 py-0.5 rounded-full self-start">
                              <%= user_attendance.status %>
                            </span>
                          <% end %>
                        <% else %>
                          <span class="text-[10px] text-orange-700 bg-orange-100 px-1.5 py-0.5 rounded-full self-start">
                            Êú™ÂõûÁ≠î
                          </span>
                        <% end %>
                      </div>
                    </div>
                    <% if event.note.present? %>
                      <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-white text-gray-900 text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-10 border border-gray-200 shadow-lg">
                        <%= event.note %>
                        <div class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-white"></div>
                      </div>
                    <% end %>
                  </div>
                <% else %>
                  <%# Event„ÅÆÂ†¥Âêà - „ÉÜ„Ç≠„Çπ„Éà„ÅÆ„Åø„ÅßË°®Á§∫ÔºàËÉåÊôØ„ÅØÁôΩÔºâ %>
                  <div class="p-1 relative group">
                    <span class="text-xs text-gray-700 bg-white px-1.5 py-0.5 rounded border">
                      <%= event.title %>
                    </span>
                    <% if event.note.present? %>
                      <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-white text-gray-900 text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-10 border border-gray-200 shadow-lg">
                        <%= event.note %>
                        <div class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-white"></div>
                      </div>
                    <% end %>
                  </div>
                <% end %>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div> 


<%= render 'shared/modal', modal_id: 'event-attendance-modal', title: 'Âá∫Â∏≠Áä∂Ê≥Å' do %>
  <div class="relative">
    <!-- Âè≥‰∏ä„ÅÆÁ∑®ÈõÜ„Éú„Çø„É≥ -->
    <div class="absolute top-0 right-0 z-10">
      <a href="/attendance/edit" class="inline-flex items-center px-3 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors duration-200">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
        </svg>
        Âá∫Ê¨†ÊÉÖÂ†±„ÅÆÁ∑®ÈõÜ
      </a>
    </div>
    
    <div id="event-attendance-modal-content">
      <!-- „Åì„Åì„Å´Âá∫Â∏≠Áä∂Ê≥Å„ÇíAjax„ÅßÊµÅ„ÅóËæº„ÇÄ -->
    </div>
  </div>
<% end %>


