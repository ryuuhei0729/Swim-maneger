<%# カレンダーのパーシャル %>
<div class="bg-white shadow-lg rounded-xl overflow-hidden" id="calendar" data-controller="calendar">
  <%= hidden_field_tag :current_month, @current_month.strftime("%Y-%m-%d"), data: { calendar_target: "currentMonth" } %>
  
  <%# カレンダーヘッダー %>
  <div class="bg-blue-800 p-4">
    <div class="flex items-center justify-between">
      <h3 class="text-xl font-bold text-white" data-calendar-target="header"><%= "#{@current_month.year}年#{@current_month.month}月" %></h3>
      <div class="flex space-x-2">
        <button type="button" data-action="click->calendar#prevMonth" class="p-2 bg-white/20 text-white rounded-full hover:bg-white/30 transition-colors duration-200 cursor-pointer">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
        </button>
        <button type="button" data-action="click->calendar#today" class="w-10 h-10 flex items-center justify-center bg-white/20 text-white rounded-full hover:bg-white/30 transition-colors duration-200 text-sm cursor-pointer">
          今日
        </button>
        <button type="button" data-action="click->calendar#nextMonth" class="p-2 bg-white/20 text-white rounded-full hover:bg-white/30 transition-colors duration-200 cursor-pointer">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </button>
      </div>
    </div>
  </div>

  <%# カレンダー本体 %>
  <div class="p-4">
    <%# 曜日のヘッダー %>
    <div class="grid grid-cols-7 gap-1 mb-2">
      <% %w[日 月 火 水 木 金 土].each do |day| %>
        <div class="text-center py-2 font-medium text-gray-600 text-sm">
          <%= day %>
        </div>
      <% end %>
    </div>

    <%# カレンダーの日付 %>
    <div class="grid grid-cols-7 gap-1">
      <% calendar_start = @current_month.beginning_of_month.beginning_of_week(:sunday) %>
      <% calendar_end = @current_month.end_of_month.end_of_week(:sunday) %>
      <% holidays = HolidayJp.between(calendar_start, calendar_end).index_by(&:date) %>
      <% (calendar_start..calendar_end).each do |date| %>
        <% is_today = date == Date.current %>
        <% is_current_month = date.month == @current_month.month %>
        <% is_holiday = holidays[date].present? %>
        <% is_sunday = date.sunday? %>
        <% is_saturday = date.saturday? %>
        <% events = @events_by_date&.dig(date) || [] %>
        
        <%# 背景色の決定（優先順位: 祝日 > 日曜 > 土曜） %>
        <% bg_color = if is_current_month
          if is_holiday
            'bg-red-100'
          elsif is_sunday
            'bg-red-50'
          elsif is_saturday
            'bg-blue-50'
          else
            'bg-white'
          end
        else
          'bg-gray-200'
        end %>
        
        <%# 文字色の決定（優先順位: 祝日 > 日曜 > 土曜） %>
        <% text_color = if is_holiday
          'text-red-600'
        elsif is_sunday
          'text-red-600'
        elsif is_saturday
          'text-blue-600'
        else
          is_current_month ? 'text-gray-900' : 'text-gray-400'
        end %>
        
        <div class="min-h-[100px] p-2 border rounded-lg <%= bg_color %> <%= is_today ? 'ring-2 ring-blue-500' : '' %> hover:shadow-md transition-shadow duration-200">
          <div class="flex justify-between items-start">
            <div class="text-sm font-medium <%= text_color %> <%= is_today ? 'bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center' : '' %>">
              <%= date.day %>
            </div>
            <% if is_today %>
              <span class="text-xs bg-blue-100 text-blue-800 px-1.5 py-0.5 rounded-full">今日</span>
            <% end %>
            <% if is_holiday && is_current_month %>
              <span class="text-xs bg-red-100 text-red-800 px-1.5 py-0.5 rounded-full"><%= holidays[date].name %></span>
            <% end %>
          </div>
          
          <% if events.any? %>
            <div class="mt-2 space-y-2">
              <% events.each do |event| %>
                <div class="group">
                  <div class="bg-white/80 backdrop-blur-sm rounded-md opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>
                  <div
                    class="p-2 rounded-md border border-gray-200 shadow-sm hover:shadow-md transition-all duration-200 cursor-pointer"
                    data-action="click->calendar#showEventModal"
                    data-event-id="<%= event.id %>"
                  >
                    <div class="flex flex-col space-y-1">
                      <span class="text-xs font-medium text-gray-900"><%= event.title %></span>
                      <span class="text-[10px] text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded-full self-start">
                        出席: <%= event.attendance.count %>人
                      </span>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div> 


<%= render 'shared/modal', modal_id: 'event-attendance-modal', title: '出席状況' do %>
  <div id="event-attendance-modal-content">
    <!-- ここに出席状況をAjaxで流し込む -->
  </div>
<% end %>


