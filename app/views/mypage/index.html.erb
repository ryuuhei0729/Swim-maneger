<% content_for :title, 'Mypage' %>

<div class="bg-white shadow rounded-lg p-6" data-controller="modal">
  <% if @user.present? %>
    <div class="flex items-center space-x-6 mb-4">
      <div class="flex-shrink-0">
        <% if @user.avatar.attached? %>
          <%= image_tag @user.avatar, alt: "プロフィール画像", class: "w-24 h-24 rounded-full" %>
        <% else %>
          <div class="w-24 h-24 rounded-full bg-blue-800 flex items-center justify-center">
            <span class="text-white text-3xl"><%= @user.name[0] %></span>
          </div>
        <% end %>
      </div>
      <div class="flex-1">
        <h2 class="text-2xl font-bold text-gray-900"><%= @user.name %></h2>
        <p class="text-gray-500"><%= @user.generation %><%= ordinal_suffix(@user.generation) %></p>
        <p class="text-gray-500"><%= @user.birthday.strftime('%Y年%m月%d日') %></p>
      </div>
    </div>

    <div class="mt-4 border-t border-gray-200 pt-4">
      <div class="flex justify-between items-center mb-2">
        <h3 class="text-lg font-semibold text-gray-900">自己紹介</h3>
        <button type="button" data-action="click->modal#open" data-modal-target="edit-modal" class="inline-flex items-center px-3 py-1.5 border border-transparent rounded-md text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 cursor-pointer">
          <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
          </svg>
          編集
        </button>
      </div>
      <% if @user.bio.present? %>
        <p class="text-gray-700 whitespace-pre-wrap"><%= @user.bio %></p>
      <% else %>
        <p class="text-gray-500 italic">自己紹介が設定されていません</p>
      <% end %>
    </div>
  <% else %>
    <div class="text-center py-8">
      <p class="text-gray-500">ユーザー情報が見つかりませんでした。</p>
      <%= link_to 'トップページへ戻る', root_path, class: 'mt-4 inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500' %>
    </div>
  <% end %>
</div>

<!-- ユーザー編集モーダル -->
<div id="edit-modal" class="fixed inset-0 bg-gray-500 bg-opacity-50 hidden z-50" data-modal-target="modal">
  <div class="flex items-center justify-center min-h-screen p-4" data-action="click->modal#closeBackground">
    <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full" data-action="click->modal#stopPropagation">
      <div class="p-8">
        <div class="flex justify-between items-start mb-6">
          <h3 class="text-2xl font-bold text-gray-900">自己紹介文の編集</h3>
          <button type="button" class="text-gray-400 hover:text-gray-500 cursor-pointer" data-action="click->modal#close">
            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        
        <%= form_with(model: @user, url: mypage_path, method: :patch, class: "space-y-6", multipart: true, data: { controller: "form-validation" }) do |f| %>
          <div>
            <label for="user_avatar" class="block text-sm font-medium text-gray-700 mb-2">プロフィール画像</label>
            <div class="mt-1 flex items-center space-x-4">
              <div class="flex-shrink-0">
                <% if @user.avatar.attached? %>
                  <%= image_tag @user.avatar, alt: "現在のプロフィール画像", class: "w-20 h-20 rounded-full object-cover" %>
                <% else %>
                  <div class="w-20 h-20 rounded-full bg-blue-800 flex items-center justify-center">
                    <span class="text-white text-2xl"><%= @user.name[0] %></span>
                  </div>
                <% end %>
              </div>
              <div class="flex-1">
                <%= f.file_field :avatar, class: "block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100", 
                    accept: "image/jpeg,image/png",
                    data: { action: "change->form-validation#validateFile" } %>
                <p class="mt-1 text-sm text-gray-500">JPG, PNG形式の画像をアップロードできます</p>
                <div id="file-error" class="mt-1 text-sm text-red-600 hidden"></div>
              </div>
            </div>
          </div>

          <div>
            <label for="user_bio" class="block text-sm font-medium text-gray-700 mb-2">自己紹介</label>
            <div class="mt-1">
              <%= f.text_area :bio, rows: 7, class: "block w-full rounded-md border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-3" %>
            </div>
          </div>

          <div class="mt-6 sm:mt-5 sm:flex sm:flex-row-reverse">
            <%= f.submit "保存", class: "inline-flex w-full justify-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 sm:ml-3 sm:w-auto cursor-pointer" %>
            <button type="button" data-action="click->modal#close" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto cursor-pointer">
              キャンセル
            </button>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- モーダル用のJavaScript -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const modalController = {
      open(event) {
        const modalId = event.currentTarget.dataset.modalTarget;
        const modal = document.getElementById(modalId);
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      },
      close(event) {
        const modal = event.currentTarget.closest('[data-modal-target="modal"]');
        modal.classList.add('hidden');
        document.body.style.overflow = '';
      },
      closeBackground(event) {
        // モーダルの背景部分がクリックされた場合のみ閉じる
        if (event.target === event.currentTarget) {
          const modal = event.currentTarget.closest('[data-modal-target="modal"]');
          modal.classList.add('hidden');
          document.body.style.overflow = '';
        }
      },
      stopPropagation(event) {
        // イベントの伝播を停止（モーダル内のクリックが背景に伝わらないようにする）
        event.stopPropagation();
      }
    };

    // モーダルを開くボタンのイベントリスナー
    document.querySelectorAll('[data-action="click->modal#open"]').forEach(button => {
      button.addEventListener('click', function(event) {
        modalController.open(event);
      });
    });

    // モーダルを閉じるボタンのイベントリスナー
    document.querySelectorAll('[data-action="click->modal#close"]').forEach(button => {
      button.addEventListener('click', function(event) {
        modalController.close(event);
      });
    });

    // モーダルの背景部分のイベントリスナー
    document.querySelectorAll('[data-action="click->modal#closeBackground"]').forEach(modal => {
      modal.addEventListener('click', function(event) {
        modalController.closeBackground(event);
      });
    });

    // モーダルの内容部分のイベントリスナー
    document.querySelectorAll('[data-action="click->modal#stopPropagation"]').forEach(content => {
      content.addEventListener('click', function(event) {
        modalController.stopPropagation(event);
      });
    });

    // ESCキーでモーダルを閉じる
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        const visibleModal = document.querySelector('[data-modal-target="modal"]:not(.hidden)');
        if (visibleModal) {
          visibleModal.classList.add('hidden');
          document.body.style.overflow = '';
        }
      }
    });

    // フォームバリデーション
    const formValidation = {
      validateFile(event) {
        const fileInput = event.target;
        const fileError = document.getElementById('file-error');
        const submitButton = document.querySelector('input[type="submit"]');
        
        if (fileInput.files.length > 0) {
          const file = fileInput.files[0];
          const fileType = file.type;
          
          if (fileType !== 'image/jpeg' && fileType !== 'image/png') {
            fileError.textContent = 'JPGまたはPNG形式の画像のみアップロード可能です';
            fileError.classList.remove('hidden');
            submitButton.disabled = true;
            submitButton.classList.add('opacity-50', 'cursor-not-allowed');
          } else {
            fileError.classList.add('hidden');
            submitButton.disabled = false;
            submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
          }
        } else {
          fileError.classList.add('hidden');
          submitButton.disabled = false;
          submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      }
    };

    // ファイル入力のイベントリスナー
    document.querySelectorAll('[data-action="change->form-validation#validateFile"]').forEach(input => {
      input.addEventListener('change', formValidation.validateFile);
    });
  });
</script>

<% if @user.present? %>
  <div class="mt-8 grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
    <div class="bg-white overflow-hidden shadow rounded-lg">
      <div class="p-5">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <svg class="h-6 w-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
            </svg>
          </div>
          <div class="ml-5 w-0 flex-1">
            <dl>
              <dt class="text-sm font-medium text-gray-500 truncate">
                今月の出席回数
              </dt>
              <dd class="flex items-baseline">
                <div class="text-2xl font-semibold text-gray-900">
                  15回
                </div>
              </dd>
            </dl>
          </div>
        </div>
      </div>
    </div>

    <div class="bg-white overflow-hidden shadow rounded-lg">
      <div class="p-5">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <svg class="h-6 w-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
          </div>
          <div class="ml-5 w-0 flex-1">
            <dl>
              <dt class="text-sm font-medium text-gray-500 truncate">
                ベストタイム（50m自由形）
              </dt>
              <dd class="flex items-baseline">
                <div class="text-2xl font-semibold text-gray-900">
                  <% if @best_times['50M_FR'].present? %>
                    <%= format_time(@best_times['50M_FR']) %>
                  <% else %>
                    -
                  <% end %>
                </div>
                <span class="ml-2 text-sm text-gray-500">秒</span>
              </dd>
            </dl>
          </div>
        </div>
      </div>
    </div>

    <div class="bg-white overflow-hidden shadow rounded-lg">
      <div class="p-5">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <svg class="h-6 w-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
          </div>
          <div class="ml-5 w-0 flex-1">
            <dl>
              <dt class="text-sm font-medium text-gray-500 truncate">
                目標達成率
              </dt>
              <dd class="flex items-baseline">
                <div class="text-2xl font-semibold text-gray-900">
                  75%
                </div>
              </dd>
            </dl>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ベストタイム一覧 -->
  <div class="mt-12">
    <div class="flex items-center mb-8">
      <h3 class="text-2xl font-bold text-gray-900 mr-4">My Best Time</h3>
      <div class="h-1 flex-grow bg-gradient-to-r from-blue-800 to-blue-400 rounded-full"></div>
    </div>

    <div class="mb-8">
      <div class="flex w-full">
        <% style_order = { 'fr' => 0, 'br' => 1, 'ba' => 2, 'fly' => 3, 'im' => 4 } %>
        <% style_titles = { 'fr' => '自由形', 'br' => '平泳ぎ', 'ba' => '背泳ぎ', 'fly' => 'バタフライ', 'im' => '個人メドレー' } %>
        <% style_header_colors = { 'fr' => 'bg-yellow-50', 'br' => 'bg-green-50', 'ba' => 'bg-red-50', 'fly' => 'bg-blue-50', 'im' => 'bg-purple-50' } %>
        <% Style.all.group_by(&:style).sort_by { |style_type, _| style_order[style_type] || 5 }.each do |style_type, styles| %>
          <div class="flex-1 min-w-0 mx-1 rounded-xl shadow-sm hover:shadow-lg transition-all duration-300 p-5 border border-gray-100 flex flex-col
            <%= 'bg-yellow-50' if style_type == 'fr' %>
            <%= 'bg-green-50' if style_type == 'br' %>
            <%= 'bg-red-50' if style_type == 'ba' %>
            <%= 'bg-blue-50' if style_type == 'fly' %>
            <%= 'bg-purple-50' if style_type == 'im' %>" style="min-width:180px;">
            <h3 class="text-lg font-bold mb-4 text-blue-800 text-center pb-2 border-b border-gray-300">
              <%= style_titles[style_type] || style_type %>
            </h3>
            <table class="w-full">
              <% styles.each do |style| %>
                <tr>
                  <td class="py-2.5 text-gray-600 font-medium w-1/2 text-center"><%= style.name_jp.match(/\d+m/)[0] %></td>
                  <td class="py-2.5 w-1/2 text-center">
                    <div class="group relative">
                      <span class="<%= @best_times[style.name].present? ? 'cursor-help font-semibold text-gray-800' : 'text-gray-400' %>">
                        <%= @best_times[style.name].present? ? format_time(@best_times[style.name]) : '-' %>
                      </span>
                      <% if defined?(@best_time_notes) && @best_time_notes[style.name].present? %>
                        <div class="hidden group-hover:block absolute z-10 bg-gray-900 text-white text-sm rounded-lg py-2 px-3 mt-1 shadow-lg min-w-[200px] transform -translate-x-1/2 left-1/2">
                          <%= @best_time_notes[style.name] %>
                          <div class="absolute -top-2 left-1/2 transform -translate-x-1/2 w-3 h-3 bg-gray-900 rotate-45"></div>
                        </div>
                      <% end %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </table>
          </div>
        <% end %>
      </div>
    </div>

    <!-- 記録履歴 -->
    <div class="flex items-center mb-8">
      <h3 class="text-2xl font-bold text-gray-900 mr-4">My Records</h3>
      <div class="h-1 flex-grow bg-gradient-to-r from-blue-800 to-blue-400 rounded-full"></div>
    </div>
    <div class="bg-white rounded-xl shadow-sm hover:shadow-lg transition-all duration-300 p-5 border border-gray-100">
      <table class="w-full">
        <thead>
          <tr class="border-b border-gray-200">
            <th class="py-3 text-left text-gray-600 font-medium">種目</th>
            <th class="py-3 text-left text-gray-600 font-medium">タイム</th>
            <th class="py-3 text-left text-gray-600 font-medium">日付</th>
            <th class="py-3 text-left text-gray-600 font-medium">メモ</th>
          </tr>
        </thead>
        <tbody>
          <% @records.each do |record| %>
            <tr class="border-b border-gray-100">
              <td class="py-3"><%= record.style.name_jp %></td>
              <td class="py-3"><%= format_time(record.time) %></td>
              <td class="py-3"><%= record.created_at.strftime("%Y/%m/%d") %></td>
              <td class="py-3"><%= record.note %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
<% end %> 