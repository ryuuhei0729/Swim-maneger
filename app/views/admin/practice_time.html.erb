<% content_for :title, '練習タイム入力' %>

<div class="w-full pt-8" data-controller="practice-time">
  <div class="text-center mb-12">
    <h1 class="text-4xl font-bold text-gray-900 mb-3">練習タイム入力</h1>
    <p class="text-lg text-gray-600">練習でのタイムを入力します</p>
  </div>

  <div class="bg-white rounded-xl shadow-lg overflow-hidden">
    <div class="p-6">
      <%= form_tag admin_practice_time_path, method: :get, class: "space-y-6" do %>
        <!-- 練習選択 -->
        <div>
          <label for="event_attendance" class="block text-sm font-medium text-gray-700">練習を選択</label>
          <select id="event_attendance" name="event_attendance_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
            <option value="">練習を選択</option>
            <% @attendance_events.each do |event| %>
              <option value="<%= event.id %>" <%= 'selected' if event == @default_event %>>
                <%= event.date.strftime('%Y/%m/%d') %> <%= event.title %>
              </option>
            <% end %>
          </select>
        </div>

        <!-- 本数・セット数入力 -->
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="laps" class="block text-sm font-medium text-gray-700">本数</label>
            <input type="number" id="laps" name="laps" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="本数を入力">
          </div>
          <div>
            <label for="sets" class="block text-sm font-medium text-gray-700">セット数</label>
            <input type="number" id="sets" name="sets" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="セット数を入力">
          </div>
        </div>

        <!-- 作成ボタン -->
        <div class="flex justify-center">
          <button type="submit" id="createTableBtn"
                  class="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
            テーブルを作成
          </button>
        </div>

        <!-- タイム入力テーブル -->
        <div id="timeInputTable" class="mt-6">
          <!-- テーブルはJavaScriptで動的に生成 -->
        </div>

        <!-- 送信ボタン -->
        <div class="flex justify-end space-x-4">
          <%= link_to 'キャンセル', admin_practice_path, class: "px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" %>
          <button type="submit" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
            タイムを保存
          </button>
        </div>
      <% end %>
    </div>
  </div>

  <!-- モーダル -->
  <div id="tableModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 <%= 'hidden' unless @show_modal %> overflow-y-auto" data-practice-time-target="modal">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full my-8">
        <div class="p-6">
          <div class="flex justify-between items-center mb-4 sticky top-0 bg-white z-10">
            <h3 class="text-lg font-medium text-gray-900">タイム入力テーブル</h3>
            <button type="button" class="text-gray-400 hover:text-gray-500" onclick="document.getElementById('tableModal').classList.add('hidden')">
              <span class="sr-only">閉じる</span>
              <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          <div id="modalTableContent" class="overflow-y-auto">
            <% if @show_modal %>
              <% @sets.times do |set| %>
                <div class="mb-8">
                  <h3 class="text-lg font-medium text-gray-900 mb-4">セット<%= set + 1 %></h3>
                  <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                      <thead class="bg-gray-50">
                        <tr class="space-x-1">
                          <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">本数</th>
                          <% if @attendees.present? %>
                            <% @attendees.each do |attendee| %>
                              <th class="px-2 py-3 text-left text-xs font-medium text-gray-800 uppercase tracking-wider">
                                <div class="flex items-center space-x-2">
                                  <span class="whitespace-nowrap"><%= attendee.name %></span>
                                </div>
                              </th>
                            <% end %>
                          <% else %>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-800 uppercase tracking-wider">
                              <div class="text-red-500">参加者情報がありません</div>
                            </th>
                          <% end %>
                        </tr>
                      </thead>
                      <tbody class="bg-white divide-y divide-gray-200">
                        <% @laps.times do |lap| %>
                          <tr class="space-x-1">
                            <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-500"><%= lap + 1 %>本目</td>
                            <% if @attendees.present? %>
                              <% @attendees.each do |attendee| %>
                                <td class="px-2 py-4 whitespace-nowrap">
                                  <input type="text" 
                                         class="block w-16 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-center placeholder-gray-300" 
                                         name="time_set<%= set + 1 %>_lap<%= lap + 1 %>_user<%= attendee.id %>" 
                                         placeholder="0:00.0" 
                                         pattern="[0-9]{1,2}:[0-9]{2}.[0-9]{2}">
                                </td>
                              <% end %>
                            <% else %>
                              <td class="px-2 py-4 whitespace-nowrap">
                                <div class="text-red-500">-</div>
                              </td>
                            <% end %>
                          </tr>
                        <% end %>
                      </tbody>
                    </table>
                  </div>
                </div>
              <% end %>
            <% end %>
          </div>
          <!-- 閉じるボタン -->
          <div class="mt-6 flex justify-end">
            <button type="button" 
                    onclick="document.getElementById('tableModal').classList.add('hidden')"
                    class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
              閉じる
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
window.generateTable = function() {
  const lapsInput = document.getElementById('laps');
  const setsInput = document.getElementById('sets');
  const modalTableContent = document.getElementById('modalTableContent');
  const laps = parseInt(lapsInput.value) || 0;
  const sets = parseInt(setsInput.value) || 0;
  if (laps > 0 && sets > 0) {
    let tableHTML = '';
    for (let set = 1; set <= sets; set++) {
      tableHTML += `
        <div class=\"mb-8\">
          <h3 class=\"text-lg font-medium text-gray-900 mb-4\">セット${set}</h3>
          <div class=\"overflow-x-auto\">
            <table class=\"min-w-full divide-y divide-gray-200\">
              <thead class=\"bg-gray-50\">
                <tr>
                  <th class=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">本数</th>
                  <th class=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">
                    <div class=\"flex items-center space-x-2\">
                      <select class=\"block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500\" name=\"player_set${set}_col1\">
                        <option value=\"\">選手を選択</option>
                        <option value=\"1\">山田太郎 (1期)</option>
                        <option value=\"2\">佐藤花子 (2期)</option>
                        <option value=\"3\">鈴木一郎 (3期)</option>
                      </select>
                      <button type=\"button\" class=\"text-indigo-600 hover:text-indigo-900\" onclick=\"addColumn(${set})\">
                        <svg class=\"h-5 w-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">
                          <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 6v6m0 0v6m0-6h6m-6 0H6\" />
                        </svg>
                      </button>
                    </div>
                  </th>
                </tr>
              </thead>
              <tbody class=\"bg-white divide-y divide-gray-200\" id=\"set${set}Body\">
                ${generateRows(laps, set)}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }
    modalTableContent.innerHTML = tableHTML;
  } else {
    alert('本数とセット数を入力してください。');
  }
}

window.generateRows = function(laps, set) {
  let rowsHTML = '';
  for (let lap = 1; lap <= laps; lap++) {
    rowsHTML += `
      <tr>
        <td class=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">${lap}本目</td>
        <td class=\"px-6 py-4 whitespace-nowrap\">
          <input type=\"text\" class=\"block w-32 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500\" 
                 name=\"time_set${set}_lap${lap}_col1\" placeholder=\"00:00.00\" 
                 pattern=\"[0-9]{1,2}:[0-9]{2}.[0-9]{2}\">
        </td>
      </tr>
    `;
  }
  return rowsHTML;
}

window.addColumn = function(set) {
  const tbody = document.getElementById(`set${set}Body`);
  const rows = tbody.getElementsByTagName('tr');
  const newColumnIndex = rows[0].getElementsByTagName('td').length;
  const headerRow = tbody.previousElementSibling.querySelector('tr');
  const newHeaderCell = document.createElement('th');
  newHeaderCell.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
  newHeaderCell.innerHTML = `
    <div class=\"flex items-center space-x-2\">
      <select class=\"block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500\" name=\"player_set${set}_col${newColumnIndex}\">
        <option value=\"\">選手を選択</option>
        <option value=\"1\">山田太郎 (1期)</option>
        <option value=\"2\">佐藤花子 (2期)</option>
        <option value=\"3\">鈴木一郎 (3期)</option>
      </select>
    </div>
  `;
  headerRow.appendChild(newHeaderCell);
  for (let i = 0; i < rows.length; i++) {
    const newCell = document.createElement('td');
    newCell.className = 'px-6 py-4 whitespace-nowrap';
    newCell.innerHTML = `
      <input type=\"text\" class=\"block w-32 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500\" 
             name=\"time_set${set}_lap${i + 1}_col${newColumnIndex}\" placeholder=\"00:00.00\" 
             pattern=\"[0-9]{1,2}:[0-9]{2}.[0-9]{2}\">`;
    rows[i].appendChild(newCell);
  }
}
</script> 