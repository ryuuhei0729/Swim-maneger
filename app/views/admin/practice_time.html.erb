<% content_for :title, '練習タイム入力' %>

<div class="w-full pt-8" data-controller="practice-time">
  <div class="text-center mb-12">
    <h1 class="text-4xl font-bold text-gray-900 mb-3">練習タイム入力</h1>
    <p class="text-lg text-gray-600">練習でのタイムを入力します</p>
  </div>

  <div class="bg-white rounded-xl shadow-lg overflow-hidden">
    <div class="p-6">
      <form class="space-y-6">
        <!-- 練習選択 -->
        <div>
          <label for="event_attendance" class="block text-sm font-medium text-gray-700">練習を選択</label>
          <select id="event_attendance" name="event_attendance_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
            <option value="">練習を選択</option>
            <% @attendance_events.each do |event| %>
              <option value="<%= event.id %>" <%= 'selected' if event == @default_event %>>
                <%= event.date.strftime('%Y/%m/%d') %> <%= event.title %>
              </option>
            <% end %>
          </select>
        </div>

        <!-- 本数・セット数入力 -->
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="laps" class="block text-sm font-medium text-gray-700">本数</label>
            <input type="number" id="laps" name="laps" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="本数を入力">
          </div>
          <div>
            <label for="sets" class="block text-sm font-medium text-gray-700">セット数</label>
            <input type="number" id="sets" name="sets" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="セット数を入力">
          </div>
        </div>

        <!-- 作成ボタン -->
        <div class="flex justify-center">
          <button type="button" id="createTableBtn"
                  data-action="practice-time#openTableModal"
                  class="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
            テーブルを作成
          </button>
        </div>

        <!-- タイム入力テーブル -->
        <div id="timeInputTable" class="mt-6">
          <!-- テーブルはJavaScriptで動的に生成 -->
        </div>

        <!-- 送信ボタン -->
        <div class="flex justify-end space-x-4">
          <%= link_to 'キャンセル', admin_practice_path, class: "px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" %>
          <button type="submit" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
            タイムを保存
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<%= render 'shared/modal', modal_id: 'tableModal', title: 'タイム入力テーブル', data: { practice_time_target: 'modal' } do %>
  <div id="modalTableContent">
    <!-- テーブルはJavaScriptで動的に生成 -->
  </div>
<% end %>

<script>
window.generateTable = function() {
  const lapsInput = document.getElementById('laps');
  const setsInput = document.getElementById('sets');
  const modalTableContent = document.getElementById('modalTableContent');
  const laps = parseInt(lapsInput.value) || 0;
  const sets = parseInt(setsInput.value) || 0;
  if (laps > 0 && sets > 0) {
    let tableHTML = '';
    for (let set = 1; set <= sets; set++) {
      tableHTML += `
        <div class=\"mb-8\">
          <h3 class=\"text-lg font-medium text-gray-900 mb-4\">セット${set}</h3>
          <div class=\"overflow-x-auto\">
            <table class=\"min-w-full divide-y divide-gray-200\">
              <thead class=\"bg-gray-50\">
                <tr>
                  <th class=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">本数</th>
                  <th class=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">
                    <div class=\"flex items-center space-x-2\">
                      <select class=\"block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500\" name=\"player_set${set}_col1\">
                        <option value=\"\">選手を選択</option>
                        <option value=\"1\">山田太郎 (1期)</option>
                        <option value=\"2\">佐藤花子 (2期)</option>
                        <option value=\"3\">鈴木一郎 (3期)</option>
                      </select>
                      <button type=\"button\" class=\"text-indigo-600 hover:text-indigo-900\" onclick=\"addColumn(${set})\">
                        <svg class=\"h-5 w-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">
                          <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 6v6m0 0v6m0-6h6m-6 0H6\" />
                        </svg>
                      </button>
                    </div>
                  </th>
                </tr>
              </thead>
              <tbody class=\"bg-white divide-y divide-gray-200\" id=\"set${set}Body\">
                ${generateRows(laps, set)}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }
    modalTableContent.innerHTML = tableHTML;
  } else {
    alert('本数とセット数を入力してください。');
  }
}

window.generateRows = function(laps, set) {
  let rowsHTML = '';
  for (let lap = 1; lap <= laps; lap++) {
    rowsHTML += `
      <tr>
        <td class=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">${lap}本目</td>
        <td class=\"px-6 py-4 whitespace-nowrap\">
          <input type=\"text\" class=\"block w-32 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500\" 
                 name=\"time_set${set}_lap${lap}_col1\" placeholder=\"00:00.00\" 
                 pattern=\"[0-9]{1,2}:[0-9]{2}.[0-9]{2}\">
        </td>
      </tr>
    `;
  }
  return rowsHTML;
}

window.addColumn = function(set) {
  const tbody = document.getElementById(`set${set}Body`);
  const rows = tbody.getElementsByTagName('tr');
  const newColumnIndex = rows[0].getElementsByTagName('td').length;
  const headerRow = tbody.previousElementSibling.querySelector('tr');
  const newHeaderCell = document.createElement('th');
  newHeaderCell.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
  newHeaderCell.innerHTML = `
    <div class=\"flex items-center space-x-2\">
      <select class=\"block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500\" name=\"player_set${set}_col${newColumnIndex}\">
        <option value=\"\">選手を選択</option>
        <option value=\"1\">山田太郎 (1期)</option>
        <option value=\"2\">佐藤花子 (2期)</option>
        <option value=\"3\">鈴木一郎 (3期)</option>
      </select>
    </div>
  `;
  headerRow.appendChild(newHeaderCell);
  for (let i = 0; i < rows.length; i++) {
    const newCell = document.createElement('td');
    newCell.className = 'px-6 py-4 whitespace-nowrap';
    newCell.innerHTML = `
      <input type=\"text\" class=\"block w-32 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500\" 
             name=\"time_set${set}_lap${i + 1}_col${newColumnIndex}\" placeholder=\"00:00.00\" 
             pattern=\"[0-9]{1,2}:[0-9]{2}.[0-9]{2}\">`;
    rows[i].appendChild(newCell);
  }
}
</script> 