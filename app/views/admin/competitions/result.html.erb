<div class="p-6 bg-white rounded-lg shadow-md">
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-2xl font-bold text-gray-800">大会結果入力</h2>
    <%= link_to "大会一覧に戻る", admin_competition_path, 
        class: "bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200" %>
  </div>

  <!-- 大会情報 -->
  <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
    <h3 class="text-lg font-semibold text-blue-800 mb-2"><%= @competition.title %></h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-blue-700">
      <div>
        <span class="font-medium">開催日:</span> <%= @competition.date.strftime("%Y年%m月%d日") %>
      </div>
      <div>
        <span class="font-medium">開催場所:</span> <%= @competition.place %>
      </div>
      <div>
        <span class="font-medium">エントリー数:</span> <%= @entries.count %>件
      </div>
    </div>
  </div>

  <!-- 結果入力フォーム -->
  <% if @entries.any? %>
    <div class="mb-6">
      <h3 class="text-lg font-semibold mb-4 text-gray-700">エントリー一覧と結果入力</h3>
      
      <% @entries.group_by(&:style).each do |style, style_entries| %>
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
          <h4 class="text-lg font-semibold text-gray-800 mb-4 border-b border-gray-200 pb-2">
            <%= style.name_jp %>
          </h4>
          
          <%= form_with url: admin_competition_save_results_path(@competition), method: :patch, local: true, class: "space-y-6" do |form| %>
            <div class="overflow-x-auto">
              <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                <thead class="bg-gray-100">
                  <tr>
                    <th class="px-4 py-2 border-b border-gray-200 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">
                      選手
                    </th>
                    <th class="px-4 py-2 border-b border-gray-200 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">
                      期
                    </th>
                    <th class="px-4 py-2 border-b border-gray-200 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">
                      エントリータイム
                    </th>
                    <th class="px-4 py-2 border-b border-gray-200 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">
                      ベストタイム
                    </th>
                    <th class="px-4 py-2 border-b border-gray-200 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">
                      記録タイム
                    </th>
                    <th class="px-4 py-2 border-b border-gray-200 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">
                      Split Time
                    </th>
                    <th class="px-4 py-2 border-b border-gray-200 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">
                      備考
                    </th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  <% style_entries.each do |entry| %>
                    <tr data-entry-id="<%= entry.id %>" class="<%= @best_time_updated[entry.id] ? 'best-record-row bg-gradient-to-r from-yellow-50 to-orange-50 border-l-4 border-yellow-400' : '' %>">
                      <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                        <%= entry.user.name %>
                      </td>
                      <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                        <%= entry.user.generation %>期
                      </td>
                      <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                        <%= entry.formatted_entry_time %>
                      </td>
                      <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                        <% if @best_times[entry.id] %>
                          <span class="text-blue-600 font-medium"><%= @best_times[entry.id] %></span>
                        <% else %>
                          <span class="text-gray-400">未記録</span>
                        <% end %>
                      </td>
                      <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                        <div class="flex items-center space-x-2">
                          <%= form.text_field "record_time_#{entry.id}", 
                              value: @records[entry.id] ? format_split_time(@records[entry.id].time) : "",
                              placeholder: "00:00.00", 
                              class: "border border-gray-300 rounded px-2 py-1 text-sm w-24" %>
                          <% if @best_time_updated[entry.id] %>
                            <div class="best-record-badge bg-gradient-to-r from-red-500 to-pink-500 text-white font-bold text-xs px-2 py-0.5 rounded-full shadow-lg border-2 border-yellow-400">
                              <span class="flex items-center">
                                Best Record!!
                              </span>
                            </div>
                          <% end %>
                        </div>
                      </td>
                      <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                        <div class="split-times-container" data-entry-id="<%= entry.id %>">
                          <% if @records[entry.id]&.split_times.present? %>
                            <% @records[entry.id].split_times.order(:distance).each_with_index do |split_time, index| %>
                              <div class="flex items-center space-x-2 mb-2">
                                <input type="number" 
                                       name="split_distance_<%= entry.id %>_<%= index %>" 
                                       value="<%= split_time.distance %>"
                                       min="0" 
                                       class="border border-gray-300 rounded px-2 py-1 text-xs w-16"
                                       required>
                                <span class="text-xs text-gray-500">m</span>
                                <input type="text" 
                                       name="split_time_<%= entry.id %>_<%= index %>" 
                                       value="<%= format_split_time(split_time.split_time) %>"
                                       placeholder="00:00.00" 
                                       class="border border-gray-300 rounded px-2 py-1 text-xs w-20"
                                       required>
                                <button type="button" 
                                        class="remove-split-time-btn text-red-500 hover:text-red-700"
                                        onclick="this.parentElement.remove()">
                                  <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                  </svg>
                                </button>
                              </div>
                            <% end %>
                          <% end %>
                        </div>
                        <button type="button" 
                                class="add-split-time-btn mt-2 inline-flex items-center px-2 py-1 border border-transparent text-xs font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
                                data-entry-id="<%= entry.id %>">
                          <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                          </svg>
                          Split Time追加
                        </button>
                      </td>
                      <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                        <%= form.text_field "note_#{entry.id}", 
                            placeholder: "備考", 
                            class: "border border-gray-300 rounded px-2 py-1 text-sm w-32" %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
            
            <div class="flex justify-end">
              <%= form.submit "保存", 
                  class: "bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-lg transition duration-200" %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  <% else %>
    <div class="text-center py-8">
      <p class="text-gray-500">この大会にはエントリーがありません。</p>
      <p class="text-sm text-gray-400 mt-2">エントリーが提出されてから結果を入力できます。</p>
    </div>
  <% end %>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Split Time追加ボタンのイベントリスナー
  document.querySelectorAll('.add-split-time-btn').forEach(button => {
    button.addEventListener('click', function() {
      const entryId = this.getAttribute('data-entry-id');
      const container = document.querySelector(`.split-times-container[data-entry-id="${entryId}"]`);
      addSplitTimeField(container, entryId);
    });
  });

  // Split Time入力欄を追加する関数
  function addSplitTimeField(container, entryId) {
    const splitTimeIndex = container.children.length;
    const splitTimeDiv = document.createElement('div');
    splitTimeDiv.className = 'flex items-center space-x-2 mb-2';
    splitTimeDiv.innerHTML = `
      <input type="number" 
             name="split_distance_${entryId}_${splitTimeIndex}" 
             placeholder="距離" 
             min="0" 
             class="border border-gray-300 rounded px-2 py-1 text-xs w-16"
             required>
      <span class="text-xs text-gray-500">m</span>
      <input type="text" 
             name="split_time_${entryId}_${splitTimeIndex}" 
             placeholder="00:00.00" 
             class="border border-gray-300 rounded px-2 py-1 text-xs w-20"
             required>
      <button type="button" 
              class="remove-split-time-btn text-red-500 hover:text-red-700"
              onclick="this.parentElement.remove()">
        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    `;
    container.appendChild(splitTimeDiv);
  }

  // 既存のsplit time入力欄の削除ボタンにイベントリスナーを追加
  document.querySelectorAll('.remove-split-time-btn').forEach(button => {
    button.addEventListener('click', function() {
      this.parentElement.remove();
    });
  });

  // ベストタイム更新行の特別な効果
  document.querySelectorAll('.best-record-row').forEach(row => {
    // 行全体にキラキラ効果を追加
    row.style.boxShadow = '0 0 10px rgba(251, 191, 36, 0.5)';
    
    // 選手名を強調表示
    const playerName = row.querySelector('td:first-child');
    if (playerName) {
      playerName.innerHTML = `<span class="font-bold text-yellow-600">${playerName.textContent}</span>`;
    }
  });
});

// カスタムCSSアニメーション
const style = document.createElement('style');
style.textContent = `
  .best-record-row {
    transition: all 0.3s ease;
  }
`;
document.head.appendChild(style);
</script> 